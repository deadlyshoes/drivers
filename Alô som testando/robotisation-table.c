#include <stdio.h>
#include <stdbool.h>
#include <stdlib.h>
#include <math.h>
#include <string.h>

#define windowSize 64

long long x[windowSize];
long long Xr[windowSize];
long long Xi[windowSize];

int x_old[windowSize];
float Xr_old[windowSize];
float Xi_old[windowSize];

long long cos_test[12][64] = {{1000000,1000000,1000000,1000000,1000000,1000000,1000000,1000000,1000000,1000000,
1000000,1000000,1000000,1000000,1000000,1000000,1000000,1000000,1000000,1000000,
1000000,1000000,1000000,1000000,1000000,1000000,1000000,1000000,1000000,1000000,
1000000,1000000,1000000,1000000,1000000,1000000,1000000,1000000,1000000,1000000,
1000000,1000000,1000000,1000000,1000000,1000000,1000000,1000000,1000000,1000000,
1000000,1000000,1000000,1000000,1000000,1000000,1000000,1000000,1000000,1000000,
1000000,1000000,1000000,1000000},
{1000000,995184,980785,956940,923879,881921,831469,773010,707106,634393,
555570,471396,382683,290284,195090,98017,0,-98016,-195089,-290284,
-382683,-471396,-555569,-634392,-707106,-773010,-831469,-881921,-923879,-956940,
-980785,-995184,-999999,-995184,-980785,-956940,-923879,-881921,-831470,-773010,
-707107,-634393,-555570,-471397,-382684,-290285,-195091,-98018,0,98016,
195089,290283,382682,471395,555569,634392,707105,773009,831468,881920,
923879,956939,980785,995184},
{1000000,980785,923879,831469,707106,555570,382683,195090,0,-195089,
-382683,-555569,-707106,-831469,-923879,-980785,-999999,-980785,-923879,-831470,
-707107,-555570,-382684,-195091,0,195089,382682,555569,707105,831468,
923879,980785,999999,980785,923880,831470,707107,555571,382684,195091,
1,-195088,-382681,-555568,-707105,-831468,-923878,-980784,-999999,-980785,
-923880,-831470,-707108,-555572,-382685,-195092,-2,195088,382681,555568,
707105,831468,923878,980784},
{1000000,956940,831469,634393,382683,98017,-195089,-471396,-707106,-881921,
-980785,-995184,-923879,-773010,-555570,-290285,0,290283,555569,773009,
923879,995184,980785,881921,707107,471398,195091,-98015,-382681,-634391,
-831468,-956939,-999999,-956940,-831470,-634394,-382685,-98019,195088,471394,
707105,881920,980784,995184,923880,773012,555572,290287,2,-290281,
-555567,-773008,-923878,-995184,-980785,-881922,-707109,-471399,-195093,98013,
382680,634390,831467,956939},
{1000000,923879,707106,382683,0,-382683,-707106,-923879,-999999,-923879,
-707107,-382684,0,382682,707105,923879,999999,923880,707107,382684,
1,-382681,-707105,-923878,-999999,-923880,-707108,-382685,-2,382681,
707105,923878,999999,923880,707108,382686,2,-382680,-707104,-923878,
-999999,-923880,-707109,-382686,-3,382680,707104,923878,999999,923881,
707109,382687,4,-382679,-707103,-923877,-999999,-923881,-707110,-382687,
-4,382678,707103,923877},
{1000000,881921,555570,98017,-382683,-773010,-980785,-956940,-707107,-290285,
195089,634392,923879,995184,831470,471398,1,-471395,-831468,-995184,
-923880,-634394,-195092,290282,707105,956939,980785,773012,382686,-98014,
-555567,-881919,-999999,-881922,-555573,-98020,382680,773008,980784,956941,
707109,290288,-195086,-634389,-923877,-995185,-831472,-471400,-4,471392,
831466,995184,923881,634397,195095,-290279,-707102,-956938,-980786,-773014,
-382689,98010,555564,881918},
{1000000,831469,382683,-195089,-707106,-980785,-923879,-555570,0,555569,
923879,980785,707107,195091,-382681,-831468,-999999,-831470,-382685,195088,
707105,980784,923880,555572,2,-555567,-923878,-980785,-707109,-195093,
382680,831467,999999,831471,382687,-195086,-707103,-980784,-923881,-555574,
-4,555566,923877,980786,707110,195095,-382678,-831466,-999999,-831472,
-382689,195084,707102,980784,923882,555575,6,-555564,-923876,-980786,
-707111,-195097,382676,831465},
{1000000,773010,195090,-471396,-923879,-956940,-555570,98016,707105,995184,
831470,290286,-382681,-881920,-980785,-634394,-2,634391,980784,881922,
382686,-290281,-831467,-995185,-707109,-98020,555567,956939,923881,471400,
-195086,-773007,-999999,-773013,-195095,471392,923877,956941,555574,-98011,
-707102,-995184,-831472,-290290,382677,881918,980786,634398,6,-634387,
-980783,-881924,-382690,290277,831465,995185,707112,98025,-555563,-956937,
-923882,-471404,195081,773004},
{1000000,707106,0,-707106,-999999,-707107,0,707105,999999,707107,
1,-707105,-999999,-707108,-2,707105,999999,707108,2,-707104,
-999999,-707109,-3,707104,999999,707109,4,-707103,-999999,-707110,
-4,707103,999999,707110,5,-707102,-999999,-707111,-6,707102,
999999,707111,6,-707101,-999999,-707111,-7,707101,999999,707112,
8,-707100,-999999,-707112,-8,707100,999999,707113,9,-707099,
-999999,-707113,-10,707099},
{1000000,634393,-195089,-881921,-923879,-290285,555569,995184,707107,-98015,
-831468,-956940,-382685,471394,980784,773012,2,-773008,-980785,-471399,
382680,956939,831471,98021,-707103,-995185,-555574,290279,923877,881923,
195095,-634388,-999999,-634397,195084,881918,923882,290291,-555564,-995184,
-707111,98009,831465,956942,382690,-471389,-980783,-773015,-8,773004,
980787,471405,-382674,-956937,-831475,-98027,707099,995185,555579,-290274,
-923875,-881926,-195101,634384},
{1000000,555570,-382683,-980785,-707107,195089,923879,831470,1,-831468,
-923880,-195092,707105,980785,382686,-555567,-999999,-555573,382680,980784,
707109,-195086,-923877,-831472,-4,831466,923881,195095,-707102,-980786,
-382689,555564,999999,555575,-382677,-980783,-707111,195082,923876,831474,
8,-831464,-923882,-195098,707100,980787,382692,-555562,-999999,-555578,
382673,980783,707114,-195079,-923875,-831475,-11,831463,923884,195102,
-707098,-980787,-382695,555559},
{1000000,471396,-555569,-995184,-382684,634392,980785,290286,-707105,-956940,
-195092,773008,923880,98020,-831467,-881922,-3,881919,831471,-98012,
-923877,-773013,195085,956938,707110,-290279,-980784,-634397,382677,995184,
555575,-471390,-999999,-471403,555563,995185,382690,-634386,-980786,-290293,
707100,956943,195099,-773004,-923883,-98027,831463,881926,10,-881916,
-831475,98005,923875,773018,-195078,-956936,-707115,290272,980782,634403,
-382670,-995183,-555581,471384}
};

long long sin_test[12][64] = {{0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,
0,0,0,0},
{0,98017,195090,290284,382683,471396,555570,634393,707106,773010,
831469,881921,923879,956940,980785,995184,999999,995184,980785,956940,
923879,881921,831469,773010,707107,634393,555570,471397,382683,290285,
195090,98017,0,-98016,-195089,-290283,-382682,-471396,-555569,-634392,
-707106,-773009,-831469,-881920,-923879,-956940,-980785,-995184,-999999,-995184,
-980785,-956940,-923879,-881921,-831470,-773011,-707107,-634394,-555571,-471397,
-382684,-290285,-195091,-98018},
{0,195090,382683,555570,707106,831469,923879,980785,999999,980785,
923879,831469,707107,555570,382683,195090,0,-195089,-382682,-555569,
-707106,-831469,-923879,-980785,-999999,-980785,-923879,-831470,-707107,-555571,
-382684,-195091,-1,195088,382682,555569,707105,831468,923878,980784,
999999,980785,923880,831470,707108,555571,382685,195092,1,-195088,
-382681,-555568,-707105,-831468,-923878,-980784,-999999,-980785,-923880,-831470,
-707108,-555572,-382685,-195092},
{0,290284,555570,773010,923879,995184,980785,881921,707107,471397,
195090,-98016,-382682,-634392,-831469,-956940,-999999,-956940,-831470,-634394,
-382684,-98018,195088,471395,707105,881920,980784,995184,923880,773011,
555571,290286,1,-290282,-555568,-773009,-923878,-995184,-980785,-881922,
-707108,-471398,-195092,98014,382680,634391,831468,956939,999999,956941,
831471,634395,382686,98020,-195087,-471393,-707104,-881919,-980784,-995185,
-923880,-773012,-555573,-290288},
{0,382683,707106,923879,999999,923879,707107,382683,0,-382682,
-707106,-923879,-999999,-923879,-707107,-382684,-1,382682,707105,923878,
999999,923880,707108,382685,1,-382681,-707105,-923878,-999999,-923880,
-707108,-382685,-2,382680,707104,923878,999999,923880,707108,382686,
3,-382680,-707104,-923878,-999999,-923880,-707109,-382686,-3,382679,
707103,923877,999999,923881,707109,382687,4,-382679,-707103,-923877,
-999999,-923881,-707110,-382688},
{0,471396,831469,995184,923879,634393,195090,-290283,-707106,-956940,
-980785,-773011,-382684,98015,555569,881920,999999,881922,555571,98019,
-382681,-773009,-980784,-956941,-707108,-290287,195087,634391,923878,995185,
831471,471399,3,-471393,-831467,-995184,-923880,-634396,-195094,290280,
707103,956939,980786,773013,382687,-98012,-555566,-881919,-999999,-881923,
-555574,-98022,382678,773007,980784,956941,707110,290290,-195084,-634388,
-923877,-995185,-831473,-471402},
{0,555570,923879,980785,707107,195090,-382682,-831469,-999999,-831470,
-382684,195088,707105,980784,923880,555571,1,-555568,-923878,-980785,
-707108,-195092,382680,831468,999999,831471,382686,-195087,-707104,-980784,
-923880,-555573,-3,555566,923877,980786,707109,195094,-382679,-831466,
-999999,-831472,-382688,195085,707102,980784,923881,555575,5,-555565,
-923877,-980786,-707111,-195096,382677,831465,999999,831473,382689,-195083,
-707101,-980783,-923882,-555576},
{0,634393,980785,881921,382683,-290283,-831469,-995184,-707107,-98018,
555569,956939,923880,471398,-195088,-773009,-999999,-773011,-195092,471394,
923878,956941,555572,-98013,-707104,-995184,-831471,-290288,382679,881919,
980786,634396,4,-634389,-980784,-881923,-382688,290279,831466,995185,
707110,98022,-555565,-956938,-923881,-471402,195083,773006,999999,773014,
195097,-471390,-923876,-956942,-555576,98009,707101,995183,831474,290292,
-382675,-881917,-980787,-634400},
{0,707106,999999,707107,0,-707106,-999999,-707107,-1,707105,
999999,707108,1,-707105,-999999,-707108,-2,707104,999999,707108,
3,-707104,-999999,-707109,-3,707103,999999,707109,4,-707103,
-999999,-707110,-5,707102,999999,707110,5,-707102,-999999,-707111,
-6,707102,999999,707111,7,-707101,-999999,-707112,-7,707101,
999999,707112,8,-707100,-999999,-707113,-9,707100,999999,707113,
9,-707099,-999999,-707114},
{0,773010,980785,471397,-382682,-956940,-831470,-98018,707105,995184,
555571,-290282,-923878,-881922,-195092,634391,999999,634395,-195087,-881919,
-923880,-290288,555566,995184,707109,-98012,-831466,-956941,-382688,471392,
980784,773014,5,-773006,-980786,-471402,382677,956938,831473,98024,
-707101,-995185,-555576,290277,923876,881925,195098,-634386,-999999,-634400,
195081,881916,923883,290294,-555561,-995183,-707114,98006,831463,956943,
382693,-471386,-980783,-773017},
{0,831469,923879,195090,-707106,-980785,-382684,555569,999999,555571,
-382681,-980784,-707108,195087,923878,831471,3,-831467,-923880,-195094,
707103,980786,382687,-555566,-999999,-555574,382678,980784,707110,-195084,
-923877,-831473,-6,831465,923882,195097,-707101,-980786,-382690,555563,
999999,555577,-382675,-980783,-707113,195081,923875,831474,9,-831464,
-923883,-195100,707099,980787,382693,-555560,-999999,-555579,382672,980782,
707115,-195078,-923874,-831476},
{0,881921,831469,-98016,-923879,-773011,195088,956939,707108,-290282,
-980784,-634395,382680,995184,555572,-471393,-999999,-471400,555566,995185,
382687,-634389,-980786,-290289,707102,956941,195096,-773006,-923881,-98023,
831465,881924,7,-881917,-831473,98009,923876,773015,-195081,-956937,
-707113,290275,980783,634400,-382674,-995183,-555578,471387,999999,471406,
-555560,-995185,-382694,634384,980787,290296,-707097,-956944,-195103,773002,
923884,98030,-831461,-881927}
};

void DFT(char *input_buffer) {
    int x_i[windowSize];

    for (int i = 0; i < windowSize; i++) {
        int sample = (((int)input_buffer[2 * i + 1]) << 8) + ((int)input_buffer[2 * i]);
        x[i] = sample;
        
        if (x[i] > 8191)
            x[i] = 8191;
        if (x[i] < -8192)
            x[i] = -8192;

        x_old[i] = x[i];
        //printf("%d\n", x[i]);
    }
    
    const int N = windowSize;

    float Xr_old[12];

    for (int k = 0; k < 12; k++) {
        Xr[k] = 0;
        Xi[k] = 0;

        Xr_old[k] = 0;
        Xi_old[k] = 0;
        for (int n = 0; n < N; n++) {
            Xr[k] += x[n] * cos_test[k][n];
            Xi[k] += x[n] * sin_test[k][n];

            Xr_old[k] += x_i[n] * cos(2 * 3.141592 * k * n / N);
            Xi_old[k] += x_i[n] * sin(2 * 3.141592 * k * n / N);
        }
        //printf("new: %ld, old: %f\n", Xr[k], Xr_old[k]);
    }
    //printf("\n");
}

void iDFT(char *output_buffer) {
    const int N = windowSize;

    for (int n = 0; n < N; n++) {
        x[n] = 0;
        x_old[n] = 0;
        for (int k = 0; k < 12; k++) {
            int theta = (2 * 3.141592 * k * n) / N;
            x[n] += Xr[k] * cos_test[k][n] + Xi[k] * sin_test[k][n];
            x_old[n] += Xr_old[k] * cos(theta) + Xi_old[k] * sin(theta);
        }
        x[n] /= 1000000;
        x[n] /= N;

        x_old[n] /= N;
    }

    for (int i = 0; i < N; i++) {
        output_buffer[2 * i] = (char)(x_old[i] & 255);
        output_buffer[2 * i + 1] = (char)(x_old[i] >> 8);
    }
}

int main(int argc, char **argv) {
    FILE *fin = fopen(argv[1], "r");
    FILE *fout = fopen(argv[2], "w");

    char input_buffer[128];
    char output_buffer[128];
    int ac = 0;
    int sample = 0;
    bool flag = false;

    // printf("long long sin_test[12][64] = {");
    // for (int k = 0; k < 12; k++) {
    //     printf("{");
    //     int count = 0;
    //     for (int n = 0; n < 64; n++) {
    //         long long to_dec = sin(2 * 3.141592 * k * n / windowSize) * 1000000.0;
    //         printf("%ld", to_dec);
    //         if (n < 63)
    //             printf(",");
    //         if (count > 8) {
    //             count = -1;
    //             printf("\n");
    //         }
    //         count++;
    //     }
    //     printf("}");
    //     if (k < 11)
    //         printf(",");
    //     printf("\n");
    // }
    // printf("};\n");
    // return 0;

    for (int i = 0; i < 5000000; i++) {
        char c = fgetc(fin);

        input_buffer[ac++] = c;
        if (ac == windowSize * 2) {
            DFT(input_buffer);
            iDFT(output_buffer);
            for (int j = 0; j < 2 * windowSize; j++) {
                fprintf(fout, "%c", output_buffer[j]);
                //printf("%d %d\n", (int)input_buffer[j], (int)output_buffer[j]);
            }
            memset(input_buffer, 0, 128 * sizeof(char));
            ac = 0;
        }
    }    

    return 0;
}